{"data":{"site":{"siteMetadata":{"title":"magchoの雑記","author":"magcho"}},"markdownRemark":{"id":"148077d5-d706-5426-a2f6-68986081e7f3","excerpt":"gulp-sharp で画像のリサイズをしたい時にできなかったので自分でそれっぽいのを書いた。 フロントエンドで画像を扱う時にsrcディレクトリには元の大きさの画像を用意してdist…","html":"<p><a href=\"https://www.npmjs.com/package/gulp-sharp\">gulp-sharp</a> で画像のリサイズをしたい時にできなかったので自分でそれっぽいのを書いた。</p>\n<p>フロントエンドで画像を扱う時にsrcディレクトリには元の大きさの画像を用意してdistディレクトリには適切なサイズまで小さくして公開する運用をしている。</p>\n<p>自分は欲しい大きさにresizeしてからoptimiseをしています、gulpでのresizeで一番npmでダウンロード数が多いのは<a href=\"https://www.npmjs.com/package/gulp-image-resize\">gulp-image-resize</a>です。このライブラリはGraphicsMagick か ImageMagickまたはその両方を必要とします。CIでサイトをビルドする時にこれらがインストールされていないときは自分でapt等でインストールをする必要がありますが、ciの制約でインストールができなかったのでsharpを使ってresizeさせたかった。</p>\n<p>探すと<a href=\"https://www.npmjs.com/package/gulp-sharp\">gulp-sharp</a>はあるんですが、メンテナンスされてないのでインストール時にエラーが出ました。</p>\n<p>凝ったことしなければgulpのプラグインは簡単に書けたので、ここにメモ。</p>\n<h2>自作gulp-sharp</h2>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">npm</span> i through2 gulp-util sharp</code></pre></div>\n\n        <div class=\"gatsby-code-title code-title\">\n          <span>my-gulp-sharp.js</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> through <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"through2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> gulputil <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gulp-util\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> sharp <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sharp\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">options</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n  through<span class=\"token punctuation\">.</span><span class=\"token function\">obj</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">file<span class=\"token punctuation\">,</span> encoding<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span><span class=\"token function\">isNull</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span><span class=\"token function\">isStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">gulputil<span class=\"token punctuation\">.</span>PluginError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gulp-sharp\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Streams un supported\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span><span class=\"token function\">isBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> payload <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">.</span>width <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">typeof</span> options<span class=\"token punctuation\">.</span>width <span class=\"token operator\">===</span> <span class=\"token string\">\"number\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        payload<span class=\"token punctuation\">.</span>width <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">.</span>height <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">typeof</span> options<span class=\"token punctuation\">.</span>height <span class=\"token operator\">===</span> <span class=\"token string\">\"number\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        payload<span class=\"token punctuation\">.</span>height <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token function\">sharp</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span>contents<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">resize</span><span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">toBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">new</span> <span class=\"token class-name\">gulputil<span class=\"token punctuation\">.</span>File</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n              base<span class=\"token operator\">:</span> file<span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">,</span>\n              cwd<span class=\"token operator\">:</span> file<span class=\"token punctuation\">.</span>cwd<span class=\"token punctuation\">,</span>\n              path<span class=\"token operator\">:</span> file<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">,</span>\n              contents<span class=\"token operator\">:</span> data<span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>npmでsharpとgulpプラグインを作るためにthrough2とgulp-utilをインストールします。</p>\n<p>あとはgulpfile.jsからいつも通り読み込みます。</p>\n\n        <div class=\"gatsby-code-title code-title\">\n          <span>gulpfile.js</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">cost gulp <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'gulp'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> my<span class=\"token operator\">-</span>gulp<span class=\"token operator\">-</span>sharp <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./my-gulp-sharp'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">resize</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">cb</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span><span class=\"token punctuation\">{</span>\n  gulp\n    <span class=\"token punctuation\">.</span><span class=\"token function\">src</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./img/*.+(png|jpg)'</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span>my<span class=\"token operator\">-</span>gulp<span class=\"token operator\">-</span><span class=\"token function\">sharp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> height<span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span> width<span class=\"token operator\">:</span> <span class=\"token number\">300</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span>gulp<span class=\"token punctuation\">.</span><span class=\"token function\">dist</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./dist/img'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'end'</span><span class=\"token punctuation\">,</span>cb<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>heightとwidthをオプションで渡していますが、どちらかを省略するとアスペクト比を保った数値でいい感じに縮小してくれます。</p>\n<p>sharpはfilebuffの他streamでも使えるみたいですが、今回の形でgulpで使った時はfilebuffのみで動作したので実装しませんでした。</p>","frontmatter":{"title":"GulpでSharpを使って画像のリサイズをする","tags":["Gulp"],"category":"プログラミング","date":"05/04"}},"allMarkdownRemark":{"group":[{"fieldValue":"AWS"},{"fieldValue":"Apple Watch"},{"fieldValue":"Arduino"},{"fieldValue":"Art-Net"},{"fieldValue":"Chrome"},{"fieldValue":"DMX512"},{"fieldValue":"Docker"},{"fieldValue":"GitHub Actions"},{"fieldValue":"Gulp"},{"fieldValue":"Homebrew"},{"fieldValue":"Netlify"},{"fieldValue":"OLA"},{"fieldValue":"OSS"},{"fieldValue":"dotz"},{"fieldValue":"emacs"},{"fieldValue":"gatsby.js"},{"fieldValue":"git"},{"fieldValue":"go"},{"fieldValue":"golang"},{"fieldValue":"homebrew"},{"fieldValue":"lily58"},{"fieldValue":"mac"},{"fieldValue":"macOS"},{"fieldValue":"qmk firmware"},{"fieldValue":"tmux"},{"fieldValue":"use-package"},{"fieldValue":"youtube live"},{"fieldValue":"ブログ"},{"fieldValue":"ポリッドスクリーン"},{"fieldValue":"思ったこと"},{"fieldValue":"生産性のない話"},{"fieldValue":"自作キーボード"}]}},"pageContext":{"slug":"/2020/5/gulp-sharp/","previous":{"excerpt":"キー入力が下手なのでバックスペースを連打しがちなのですがバックスペースキーはキーボード上では遥か右上にあります。これが原因で右手首を痛めたことも。入力精度を上げろという話なのですが出来るならもうしてます。 また、以外と日本語入力をしていると使いがちな「ー」伸ばし棒も近くに欲しいものです。  今回はにbackspace・にハイフンを割り当てます。 Ctrlキー Ctrlキー含め装飾キーには様々なキーバインドが割り当てられています。一般的にはにはreturn・にはbackspaceなど色々あります。zsh/bashなどのshellやターミナルのキーバインドに設定されていることが多いです。macではに行末まで削除があったりと気が利いています。 qmk firmwareではraise/lower…","fields":{"slug":"/2020/4/qmk_firmwareでctrlとの同時押しをカスタマイズする/"},"frontmatter":{"date":"04/08","title":"qmk firmwareでctrlとの同時押しをカスタマイズする","category":"プログラミング","tags":["qmk firmware","自作キーボード"]}},"next":{"excerpt":"demo asciicast gitignoreを言語とに自動生成してくれるサービスはいくつかありますが、わざわざwebサイトを開くのも面倒です。\n幸いなことにgitignore.ioがapiを提供してくれています、これを利用してgitにサブコマンドを追加しましょう。 ついでに.gitignoreを上書き・追記の確認・gitignore.ioにテンプレートが存在しない場合はエラーを表示などもあると親切ですね。shにするとこんな感じに。 .gitconfigに書くとときには全体を関数にする・ダブルクォーテーションをエスケープ・が使えないのでに差し替えなどをすると以下になります。 書いていて気づいたんですが、#はエスケープせずに動きますね。 使い方","fields":{"slug":"/2020/6/gitignore/"},"frontmatter":{"date":"06/14","title":".gitignoreを自動生成するサブコマンドを作ろう","category":"プログラミング","tags":["git"]}}}}