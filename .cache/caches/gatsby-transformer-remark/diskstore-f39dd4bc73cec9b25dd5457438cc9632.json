{"expireTime":9007200859665841000,"key":"transformer-remark-markdown-html-ast-b9484bd8497f905fe93d47c607775b31-gatsby-remark-imagesgatsby-remark-responsive-iframegatsby-remark-prismjs-titlegatsby-remark-prismjsgatsby-remark-copy-linked-filesgatsby-remark-smartypantsgatsby-remark-prismjs-","val":{"type":"root","children":[{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"内容","position":{"start":{"line":2,"column":4,"offset":4},"end":{"line":2,"column":6,"offset":6}}}],"position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":6,"offset":6}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"DockerHub の公式の PHP イメージを使っていて、mod_rewite したい人向けのお話です。結論だけ知りたい人は読み飛ばしてね。","position":{"start":{"line":4,"column":1,"offset":8},"end":{"line":4,"column":72,"offset":79}}}],"position":{"start":{"line":4,"column":1,"offset":8},"end":{"line":4,"column":72,"offset":79}}},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"事の発端","position":{"start":{"line":6,"column":4,"offset":84},"end":{"line":6,"column":8,"offset":88}}}],"position":{"start":{"line":6,"column":1,"offset":81},"end":{"line":6,"column":8,"offset":88}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"僕自身が立ち上げた web サービスではもともと URL が","position":{"start":{"line":8,"column":1,"offset":90},"end":{"line":8,"column":31,"offset":120}}},{"type":"raw","value":"<code class=\"language-text\">http://example.com/index.php?cmd=view&amp;page=123</code>","position":{"start":{"line":8,"column":31,"offset":120},"end":{"line":8,"column":79,"offset":168}}},{"type":"text","value":"という感じでとてもダサかったので、かっこよくしたかった。WordPress などではパーマリンクと呼ばれ URL がイカした感じになっているので、僕も方法をパクった。\n調べると apache 側の設定で mod_rewrite を使うとアクセス時に URL を記述したルールに基づいて置換してくれるらしい。","position":{"start":{"line":8,"column":79,"offset":168},"end":{"line":9,"column":70,"offset":321}}}],"position":{"start":{"line":8,"column":1,"offset":90},"end":{"line":9,"column":70,"offset":321}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"僕の web サービスではアクセスを全て index.php で受け、get パラメータで動作を変化させている、pukiwiki とか？の設計をパクったはず。動作ルールは以下","position":{"start":{"line":11,"column":1,"offset":323},"end":{"line":11,"column":88,"offset":410}}}],"position":{"start":{"line":11,"column":1,"offset":323},"end":{"line":11,"column":88,"offset":410}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"raw","value":"<code class=\"language-text\">example.com/index.php?cmd=[動作モード]&amp;page=[記事のNo.]</code>","position":{"start":{"line":13,"column":1,"offset":412},"end":{"line":13,"column":50,"offset":461}}}],"position":{"start":{"line":13,"column":1,"offset":412},"end":{"line":13,"column":50,"offset":461}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"cmd","position":{"start":{"line":15,"column":3,"offset":465},"end":{"line":15,"column":6,"offset":468}}}],"position":{"start":{"line":15,"column":3,"offset":465},"end":{"line":15,"column":6,"offset":468}}},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"view 記事の表示、page で記事を指定","position":{"start":{"line":16,"column":5,"offset":473},"end":{"line":16,"column":27,"offset":495}}}],"position":{"start":{"line":16,"column":3,"offset":471},"end":{"line":16,"column":27,"offset":495}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"edit 記事の編集、page で記事を指定","position":{"start":{"line":17,"column":5,"offset":500},"end":{"line":17,"column":27,"offset":522}}}],"position":{"start":{"line":17,"column":3,"offset":498},"end":{"line":17,"column":27,"offset":522}}},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"category カテゴリーごとに記事一覧を表示する　　などなど","position":{"start":{"line":18,"column":5,"offset":527},"end":{"line":18,"column":37,"offset":559}}}],"position":{"start":{"line":18,"column":3,"offset":525},"end":{"line":18,"column":37,"offset":559}}},{"type":"text","value":"\n"}],"position":{"start":{"line":16,"column":3,"offset":471},"end":{"line":18,"column":37,"offset":559}}},{"type":"text","value":"\n"}],"position":{"start":{"line":15,"column":1,"offset":463},"end":{"line":18,"column":37,"offset":559}}},{"type":"text","value":"\n"}],"position":{"start":{"line":15,"column":1,"offset":463},"end":{"line":18,"column":37,"offset":559}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"これを","position":{"start":{"line":20,"column":1,"offset":561},"end":{"line":20,"column":4,"offset":564}}},{"type":"raw","value":"<code class=\"language-text\">example.com/[動作モード]/[記事のNo.]</code>","position":{"start":{"line":20,"column":4,"offset":564},"end":{"line":20,"column":34,"offset":594}}},{"type":"text","value":"にしたかった。\nさらに view の時には","position":{"start":{"line":20,"column":34,"offset":594},"end":{"line":21,"column":14,"offset":615}}},{"type":"raw","value":"<code class=\"language-text\">example.com/[記事のNo.]</code>","position":{"start":{"line":21,"column":14,"offset":615},"end":{"line":21,"column":36,"offset":637}}},{"type":"text","value":"にしたい。","position":{"start":{"line":21,"column":36,"offset":637},"end":{"line":21,"column":41,"offset":642}}}],"position":{"start":{"line":20,"column":1,"offset":561},"end":{"line":21,"column":41,"offset":642}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"このルールで URL を置換させるには.htaccess に","position":{"start":{"line":23,"column":1,"offset":644},"end":{"line":23,"column":31,"offset":674}}}],"position":{"start":{"line":23,"column":1,"offset":644},"end":{"line":23,"column":31,"offset":674}}},{"type":"text","value":"\n"},{"type":"raw","value":"\n        <div class=\"gatsby-code-title code-title\">\n          <span>.htaccess</span>\n        </div>\n       "},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">RewriteEngine On\nRewriteBase /\nRewriteRule ^([0-9]+) index.php?cmd=view&amp;page=$1 [L]\nRewriteRule ^edit/([0-9]+) index.php?cmd=edit&amp;page=$1 [L]\nRewriteRule ^edit index.php?cmd=edit [L]\nRewriteRule ^category index.php?cmd=category [L]</code></pre></div>","position":{"start":{"line":25,"column":1,"offset":676},"end":{"line":32,"column":4,"offset":931}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"のように記述する、よくある正規表現と似ているので特に迷うことはないだろう。","position":{"start":{"line":34,"column":1,"offset":933},"end":{"line":34,"column":38,"offset":970}}}],"position":{"start":{"line":34,"column":1,"offset":933},"end":{"line":34,"column":38,"offset":970}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"いざ、Docker で立てた開発環境に置いてみると、500 エラー。なんで！！\nしばらく悩むも解決せず、諦めて本番環境に置いてみると動いた！なんで！！","position":{"start":{"line":36,"column":1,"offset":972},"end":{"line":37,"column":36,"offset":1047}}}],"position":{"start":{"line":36,"column":1,"offset":972},"end":{"line":37,"column":36,"offset":1047}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"理由は単純だった、使っているシステムが違った。どちらも apache なのは違いないが、本番は CentOS で構成されており、開発環境の Docker の公式 image の php は debian で構成されていた。","position":{"start":{"line":39,"column":1,"offset":1049},"end":{"line":39,"column":112,"offset":1160}}}],"position":{"start":{"line":39,"column":1,"offset":1049},"end":{"line":39,"column":112,"offset":1160}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://github.com/docker-library/php/blob/2630167f7e69394bdd91f240443a0a521fd7872d/7.0/apache/Dockerfile"},"children":[{"type":"text","value":"Dockerfile","position":{"start":{"line":41,"column":2,"offset":1163},"end":{"line":41,"column":12,"offset":1173}}}],"position":{"start":{"line":41,"column":1,"offset":1162},"end":{"line":41,"column":120,"offset":1281}}}],"position":{"start":{"line":41,"column":1,"offset":1162},"end":{"line":41,"column":120,"offset":1281}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"debian 系の apache で mod_rewrite を有効化するにはコンテナに入ってコマンドを打てばいいらしい。","position":{"start":{"line":43,"column":1,"offset":1283},"end":{"line":43,"column":62,"offset":1344}}}],"position":{"start":{"line":43,"column":1,"offset":1283},"end":{"line":43,"column":62,"offset":1344}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ docker exec -it {php_container_name} bash\n$ a2enmod rewrite</code></pre></div>","position":{"start":{"line":45,"column":1,"offset":1346},"end":{"line":48,"column":4,"offset":1415}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"そして/etc/apache2/sites-available/000-default.conf の<VirtualHost ","position":{"start":{"line":50,"column":1,"offset":1417},"end":{"line":50,"column":64,"offset":1480}}},{"type":"text","value":"*","position":{"start":{"line":50,"column":64,"offset":1480},"end":{"line":50,"column":66,"offset":1482}}},{"type":"text","value":":80>の中に","position":{"start":{"line":50,"column":66,"offset":1482},"end":{"line":50,"column":73,"offset":1489}}}],"position":{"start":{"line":50,"column":1,"offset":1417},"end":{"line":50,"column":73,"offset":1489}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">    &lt;Directory /var/www/html&gt;\n        Options Indexes FollowSymLinks MultiViews\n        AllowOverride All\n        Require all granted\n    &lt;/Directory&gt;</code></pre></div>","position":{"start":{"line":52,"column":1,"offset":1491},"end":{"line":58,"column":4,"offset":1649}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"を追加して再起動すれば OK!","position":{"start":{"line":60,"column":1,"offset":1651},"end":{"line":60,"column":16,"offset":1666}}}],"position":{"start":{"line":60,"column":1,"offset":1651},"end":{"line":60,"column":16,"offset":1666}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"でも、せっかく docker-compose 使ってるからいちいちコマンド打つの面倒だよね。ってことで","position":{"start":{"line":62,"column":1,"offset":1668},"end":{"line":62,"column":52,"offset":1719}}}],"position":{"start":{"line":62,"column":1,"offset":1668},"end":{"line":62,"column":52,"offset":1719}}},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"結論","position":{"start":{"line":64,"column":4,"offset":1724},"end":{"line":64,"column":6,"offset":1726}}}],"position":{"start":{"line":64,"column":1,"offset":1721},"end":{"line":64,"column":6,"offset":1726}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Dockerfile","position":{"start":{"line":66,"column":3,"offset":1730},"end":{"line":66,"column":13,"offset":1740}}}],"position":{"start":{"line":66,"column":1,"offset":1728},"end":{"line":66,"column":15,"offset":1742}}}],"position":{"start":{"line":66,"column":1,"offset":1728},"end":{"line":66,"column":15,"offset":1742}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">FROM php:7.0-apache\nRUN  a2enmod rewrite</code></pre></div>","position":{"start":{"line":68,"column":1,"offset":1744},"end":{"line":71,"column":4,"offset":1792}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"docker-compse.yml","position":{"start":{"line":73,"column":3,"offset":1796},"end":{"line":73,"column":20,"offset":1813}}}],"position":{"start":{"line":73,"column":1,"offset":1794},"end":{"line":73,"column":22,"offset":1815}}}],"position":{"start":{"line":73,"column":1,"offset":1794},"end":{"line":73,"column":22,"offset":1815}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">php-7.0</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span> .\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">'80:80'</span>\n  <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">'../:/var/www/html'</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">'./000-default.conf:/etc/apache2/sites-available/000-default.conf'</span></code></pre></div>","position":{"start":{"line":75,"column":1,"offset":1817},"end":{"line":83,"column":4,"offset":1980}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"000-default.conf","position":{"start":{"line":85,"column":3,"offset":1984},"end":{"line":85,"column":19,"offset":2000}}}],"position":{"start":{"line":85,"column":1,"offset":1982},"end":{"line":85,"column":21,"offset":2002}}}],"position":{"start":{"line":85,"column":1,"offset":1982},"end":{"line":85,"column":21,"offset":2002}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&lt;VirtualHost *:80&gt;\n    &lt;Directory /var/www/html&gt;\n        Options Indexes FollowSymLinks MultiViews\n        AllowOverride All\n        Require all granted\n    &lt;/Directory&gt;\n~~~~~~~~~~~~~~以下略~~~~~~~~~~~~~~~~</code></pre></div>","position":{"start":{"line":87,"column":1,"offset":2004},"end":{"line":95,"column":4,"offset":2215}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"この３ファイルを同じディレクトリに入れ","position":{"start":{"line":97,"column":1,"offset":2217},"end":{"line":97,"column":20,"offset":2236}}},{"type":"raw","value":"<code class=\"language-text\">docker-compose build</code>","position":{"start":{"line":97,"column":20,"offset":2236},"end":{"line":97,"column":42,"offset":2258}}},{"type":"text","value":"なりでイメージをリビルドして","position":{"start":{"line":97,"column":42,"offset":2258},"end":{"line":97,"column":56,"offset":2272}}},{"type":"raw","value":"<code class=\"language-text\">docker-compose up</code>","position":{"start":{"line":97,"column":56,"offset":2272},"end":{"line":97,"column":75,"offset":2291}}},{"type":"text","value":"でOK。","position":{"start":{"line":97,"column":75,"offset":2291},"end":{"line":97,"column":79,"offset":2295}}}],"position":{"start":{"line":97,"column":1,"offset":2217},"end":{"line":97,"column":79,"offset":2295}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"ちなみに、mysql も使いたいよって人は","position":{"start":{"line":99,"column":1,"offset":2297},"end":{"line":99,"column":22,"offset":2318}}}],"position":{"start":{"line":99,"column":1,"offset":2297},"end":{"line":99,"column":22,"offset":2318}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Dockerfile","position":{"start":{"line":101,"column":3,"offset":2322},"end":{"line":101,"column":13,"offset":2332}}}],"position":{"start":{"line":101,"column":1,"offset":2320},"end":{"line":101,"column":15,"offset":2334}}}],"position":{"start":{"line":101,"column":1,"offset":2320},"end":{"line":101,"column":15,"offset":2334}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">FROM php:7.0-apache\nRUN apt-get update &amp;&amp; \\\n  docker-php-ext-install pdo_mysql mysqli mbstring &amp;&amp; \\\n  a2enmod rewrite</code></pre></div>","position":{"start":{"line":103,"column":1,"offset":2336},"end":{"line":108,"column":4,"offset":2461}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"こうすれば良いです。","position":{"start":{"line":110,"column":1,"offset":2463},"end":{"line":110,"column":11,"offset":2473}}}],"position":{"start":{"line":110,"column":1,"offset":2463},"end":{"line":110,"column":11,"offset":2473}}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":111,"column":1,"offset":2474}}}}