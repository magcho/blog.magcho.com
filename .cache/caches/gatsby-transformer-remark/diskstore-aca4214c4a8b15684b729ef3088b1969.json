{"expireTime":9007200860071785000,"key":"transformer-remark-markdown-html-49e91a5823eff75038ffa9fb24f87a64-gatsby-remark-imagesgatsby-remark-responsive-iframegatsby-remark-prismjs-titlegatsby-remark-prismjsgatsby-remark-copy-linked-filesgatsby-remark-smartypantsgatsby-remark-prismjs-","val":"<p><a href=\"https://www.npmjs.com/package/gulp-sharp\">gulp-sharp</a> で画像のリサイズをしたい時にできなかったので自分でそれっぽいのを書いた。</p>\n<p>フロントエンドで画像を扱う時にsrcディレクトリには元の大きさの画像を用意してdistディレクトリには適切なサイズまで小さくして公開する運用をしている。</p>\n<p>自分は欲しい大きさにresizeしてからoptimiseをしています、gulpでのresizeで一番npmでダウンロード数が多いのは<a href=\"https://www.npmjs.com/package/gulp-image-resize\">gulp-image-resize</a>です。このライブラリはGraphicsMagick か ImageMagickまたはその両方を必要とします。CIでサイトをビルドする時にこれらがインストールされていないときは自分でapt等でインストールをする必要がありますが、ciの制約でインストールができなかったのでsharpを使ってresizeさせたかった。</p>\n<p>探すと<a href=\"https://www.npmjs.com/package/gulp-sharp\">gulp-sharp</a>はあるんですが、メンテナンスされてないのでインストール時にエラーが出ました。</p>\n<p>凝ったことしなければgulpのプラグインは簡単に書けたので、ここにメモ。</p>\n<h2>自作gulp-sharp</h2>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">npm</span> i through2 gulp-util sharp</code></pre></div>\n\n        <div class=\"gatsby-code-title code-title\">\n          <span>my-gulp-sharp.js</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> through <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"through2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> gulputil <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gulp-util\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> sharp <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sharp\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">options</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n  through<span class=\"token punctuation\">.</span><span class=\"token function\">obj</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">file<span class=\"token punctuation\">,</span> encoding<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span><span class=\"token function\">isNull</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span><span class=\"token function\">isStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">gulputil<span class=\"token punctuation\">.</span>PluginError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gulp-sharp\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Streams un supported\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span><span class=\"token function\">isBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> payload <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">.</span>width <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">typeof</span> options<span class=\"token punctuation\">.</span>width <span class=\"token operator\">===</span> <span class=\"token string\">\"number\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        payload<span class=\"token punctuation\">.</span>width <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">.</span>height <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">typeof</span> options<span class=\"token punctuation\">.</span>height <span class=\"token operator\">===</span> <span class=\"token string\">\"number\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        payload<span class=\"token punctuation\">.</span>height <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token function\">sharp</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span>contents<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">resize</span><span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">toBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">new</span> <span class=\"token class-name\">gulputil<span class=\"token punctuation\">.</span>File</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n              base<span class=\"token operator\">:</span> file<span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">,</span>\n              cwd<span class=\"token operator\">:</span> file<span class=\"token punctuation\">.</span>cwd<span class=\"token punctuation\">,</span>\n              path<span class=\"token operator\">:</span> file<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">,</span>\n              contents<span class=\"token operator\">:</span> data<span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>npmでsharpとgulpプラグインを作るためにthrough2とgulp-utilをインストールします。</p>\n<p>あとはgulpfile.jsからいつも通り読み込みます。</p>\n\n        <div class=\"gatsby-code-title code-title\">\n          <span>gulpfile.js</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">cost gulp <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'gulp'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> my<span class=\"token operator\">-</span>gulp<span class=\"token operator\">-</span>sharp <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./my-gulp-sharp'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">resize</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">cb</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span><span class=\"token punctuation\">{</span>\n  gulp\n    <span class=\"token punctuation\">.</span><span class=\"token function\">src</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./img/*.+(png|jpg)'</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span>my<span class=\"token operator\">-</span>gulp<span class=\"token operator\">-</span><span class=\"token function\">sharp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> height<span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span> width<span class=\"token operator\">:</span> <span class=\"token number\">300</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span>gulp<span class=\"token punctuation\">.</span><span class=\"token function\">dist</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./dist/img'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'end'</span><span class=\"token punctuation\">,</span>cb<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>heightとwidthをオプションで渡していますが、どちらかを省略するとアスペクト比を保った数値でいい感じに縮小してくれます。</p>\n<p>sharpはfilebuffの他streamでも使えるみたいですが、今回の形でgulpで使った時はfilebuffのみで動作したので実装しませんでした。</p>"}