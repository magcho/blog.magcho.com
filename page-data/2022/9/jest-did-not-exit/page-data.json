{"componentChunkName":"component---src-templates-blog-post-jsx","path":"/2022/9/jest-did-not-exit/","result":{"data":{"site":{"siteMetadata":{"title":"magcho's blog","author":"magcho"}},"markdownRemark":{"id":"ab3bdca0-4a1d-5943-9f19-f8036f5872ec","excerpt":"Jest でテストを実行すると といった表示とともに全てのテストが Pass になっているのに関わらず Jest のプロセスが数分間終了しない問題に遭遇することがあります。 エラー文で検索すると Puppeteer や DB…","html":"<p>Jest でテストを実行すると</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">Ran all <span class=\"token builtin class-name\">test</span> suites matching path<span class=\"token punctuation\">\\</span>/to<span class=\"token punctuation\">\\</span>/hoge.spec.ts/i.\nJest did not <span class=\"token builtin class-name\">exit</span> one second after the <span class=\"token builtin class-name\">test</span> run has completed.\n\nThis usually means that there are asynchronous operations that weren't stopped <span class=\"token keyword\">in</span> your tests. Consider running Jest with <span class=\"token variable\"><span class=\"token variable\">`</span>--detectOpenHandles<span class=\"token variable\">`</span></span> to troubleshoot this issue.</code></pre></div>\n<p>といった表示とともに全てのテストが Pass になっているのに関わらず Jest のプロセスが数分間終了しない問題に遭遇することがあります。</p>\n<p>エラー文で検索すると Puppeteer や DB コネクションの修了処理を忘れていてテスト時に起動した別プロセスが終了していないため、Jest がそれらの終了を待ってしまうことが多いみたいです。</p>\n<p>このような場合はツールの修了処理を追加してあげれば改善することが多いのですが、このようなツールを利用していないプロジェクトで起きた場合は原因特定・修正をする必要が出てきます。</p>\n<h2>Jest のデバッグ実行</h2>\n<p>Jest には Chromium 系のブラウザに付いている Dev Tools を利用したトラブルシューティング機能があります。(Node.js の機能ですが Jest はこれを正式にサポートしています)</p>\n<p>上記のエラーメッセージと一緒に当該の問題が発生しているテストのファイル名が表示されていると思います。このファイルのみをデバッグ実行して原因を探っていきます。</p>\n<p>Jest のドキュメントに従って</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">node</span> --inspect-brk node_modules/.bin/jest --runInBand /path/to/sample.spec.js</code></pre></div>\n<p>を実行した後、Chromium 系のブラウザで <code class=\"language-text\">chrome://inspect</code> にアクセスすると Remote Target に Jest のプロセスが表示されるので<code class=\"language-text\">inspect</code>をクリックすると見慣れた Dev tools が別ウィンドウで表示されます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/16ce34d58e395a066bb9d27fa6c3472c/3126c/jest-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.91891891891892%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA20lEQVQoz6WPTU/DMAyG+1NBgIAxPoQQJy4gOCD2H4ugY6XpmiZtEjuJY9R1O1IN8cgny4/9OjtZnM/frufPV6ePs4uXy7vF/c3r7dnT7ODh6HCo44nKWqmIkrFWKc1/JNN6cFpLnXHOOkBkZkQsy7IoCmvtlIyb6cZQ1WjZdutGoY+AmOe5ECKlNHm560Lw2vhV3a/qft06qdFH8h6JiJnTLwyyMSaEoLUSQnxXlXWQEu37c4yRmUUt3z+Wn8uvWvYACBvcDtiBiGNntLJxhwECpCEN7cU2Nv+DH/MQ8DhbTspcAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"jest 1\"\n        title=\"jest 1\"\n        src=\"/static/16ce34d58e395a066bb9d27fa6c3472c/fcda8/jest-1.png\"\n        srcset=\"/static/16ce34d58e395a066bb9d27fa6c3472c/12f09/jest-1.png 148w,\n/static/16ce34d58e395a066bb9d27fa6c3472c/e4a3f/jest-1.png 295w,\n/static/16ce34d58e395a066bb9d27fa6c3472c/fcda8/jest-1.png 590w,\n/static/16ce34d58e395a066bb9d27fa6c3472c/efc66/jest-1.png 885w,\n/static/16ce34d58e395a066bb9d27fa6c3472c/c83ae/jest-1.png 1180w,\n/static/16ce34d58e395a066bb9d27fa6c3472c/3126c/jest-1.png 1876w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>インスペクターは必ず Jest の実行直前で一時停止するようになっているので<kbd><kbd>Ctrl</kbd> + <kbd>p</kbd></kbd>を押して対象のテストファイルを開き問題箇所周辺をデバッグしていくことができます。</p>\n<p>割と忘れやすいのが、ブレイクポイントを張り終えた後、再実行しようとターミナルで<kbd>Ctrl + c</kbd>して再実行するとdev toolsとのセッションが切れます。がしかし、<strong>dev toolsの画面は自動で閉じません</strong>。Jestの再実行の後にさっきまでのdev toolsのウィンドウを閉じた後、再び<code class=\"language-text\">chrome://inspect</code>から同様に起動してください。dev toolsの作業内容はウィンドウを閉じても保持されるため新しいウィンドウでもさっき頑張って貼ったブレイクポイントのところでちゃんと止まります。</p>\n<h2>デバッグ勘所</h2>\n<p>私がこのエラーに遭遇した時に行っているデバッグ方法をを紹介します。</p>\n<h3>最初に疑うところ</h3>\n<p>私の経験則ですが、非同期やイベント周りでエラーや考慮漏れがあるとこのようなエラーになることが多かったです。テストの中で作られた Promose オブジェクトが pending のままになっていたり、Reject を返しているのにそれらを考慮していない時などにもこのようなエラーになったことがあります。</p>\n<h3>console.log を眺める</h3>\n<p>Jest をターミナルで実行している時にも<code class=\"language-text\">console.log</code>は表示されますが、ログが出力された該当箇所へのジャンプは dev tools でないとできません。</p>\n<p>ORM ライブラリなどが実行中に出力するログの出力元に何かヒントがある可能性があります。</p>\n<h3>catch されていない例外をみる</h3>\n<p>実行中に例外が投げられており、その例外をキャッチしていない箇所に自動でブレイクポイントを設定できます。<a href=\"https://developer.chrome.com/docs/devtools/javascript/breakpoints/#exceptions\">(参考)</a></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6595c7de717fd50b3a12c94ac9c44cd5/36c33/jest-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 63.51351351351351%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAABYlAAAWJQFJUiTwAAABVklEQVQoz43SXU7cMBDA8RwDVbCbbOwk/pixZ+KPJF5aECyqClL7jhAHgHv0JD1nK7QV6kN3F+n/Ysk/W7KnGpQ9VD+YfX+XygJAWdi5ccqT1lBpg/9NaRhDJo6eAjoG9NoiOo/OU1muvj9O211FYzpUyoU5ckghzRxyiHPKhdL8yrtnvmsNVimXQ8VUiONSvuT5UhsXxtwSPdH1b3h96qZPUlYxLUfiMe++Ptze3U/TVhiblP+lfzzarQFvwR/DKRdAGpS14HFMwcef7uGbL2dd17a9EP0J7HwgTgbJKHjBmxuchPNGgexV1+sTGB0TJ0vjVec/Q5KA1jrZvckPYWUQkJRB44g5AVIreiEHIYfjD1Y8hZjm5fKaQ9Ya3v7f4PvwnLjZWHd+UV+smroR4NhTNNat67ZuRN2I07hu2mYj60as1pvVevMuP4T/2S2bjdwftMd/ANrkmO15vx61AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"jest 2\"\n        title=\"jest 2\"\n        src=\"/static/6595c7de717fd50b3a12c94ac9c44cd5/fcda8/jest-2.png\"\n        srcset=\"/static/6595c7de717fd50b3a12c94ac9c44cd5/12f09/jest-2.png 148w,\n/static/6595c7de717fd50b3a12c94ac9c44cd5/e4a3f/jest-2.png 295w,\n/static/6595c7de717fd50b3a12c94ac9c44cd5/fcda8/jest-2.png 590w,\n/static/6595c7de717fd50b3a12c94ac9c44cd5/efc66/jest-2.png 885w,\n/static/6595c7de717fd50b3a12c94ac9c44cd5/36c33/jest-2.png 946w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>ここでは try-catch していない Error, Promse.reject があるとそこで実行が止まります。意図していない箇所で止まっている場合にはそこを修正することでテストの実行が改善する可能性があります。</p>\n<p>それでも見つからない場合/改善しない場合は”Pause on caught exceptions”にチェックを入れることでtry-catchしている部分ももれなく実行を一時停止することができます。</p>\n<h2>Jest上で実行されている別プロセスがないか確認する</h2>\n<p>testやdescribeの最終行にブレイクポイントを張り実行を一時停止した状態で別のターミナルでhtopなどを用いてJestの子プロセスとして起動中（終了していない）プロセスが残っていないかを確認する</p>\n<p>Jestの小プロセスにpuppeteerなどが残っているとこのように<code class=\"language-text\">node --inspect-brk ...</code>の子プロセスに表示されます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/67b08f1411831524885dc8a4221881a6/b918a/jest-3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.24324324324324%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB/ElEQVQoz23N30/aYBTG8ZcCLW3f9qWUn21BwQkFEwXdD50yFUSju9jmEr1aFreRuXmxxF0sy/73fheKS7zYxSfPeU5OcoSr7MR28ti5TGLkBL6y8FwLQxNLWYEnTTzHopAV6JpAzwhKrkVJyfRmsV+ksgxE1S+irFzi6BrFQoZA5fEMDTsjcHKCspmn4krCeo2gogh8h8CX+I5EWQUKi6eZJVMTCLm9ktijJubTVuLsrGBvhjijJt7zTjoXtgLkiw5ydw2520bttXF2V9FHEfooxNhuPhIhylUPw9TIB5JSVWHbOYqeRT0oIx0D085jyjyZrEBkBEJ7lP9zOJ1xMJmyczrh+Oyc8fGUxW52fsF4OuPo5JST89eMJye8WvTZGfuHE3bHh6m98dHDvEyx1mkTNQNa/Sd04x6rrYhOe4VBv0erFRGGDXq9deK4lxoM+vT7Mb3uOhuDmI1Bn0E/Jo676Z2olFRiGRrF0E9q1RKumcdXNlGjgjR19Kyg6ivCeoWgVqYV1lOLvrhpPojq5bSLyCvh5XKJW3WJSj6+rlOzbdaqNcoFE0eIdNeQDg3p0nBcAlcRqiKB6xIqleY/Yvj5XTKcXzKYv0k2v7zl2bdrDn58YOv2PcPvV4zurtj8ekn34wXDu2sO/tzy8vec/V9z9u9vln5+Wrq/4S+yuPRLEAakSAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"jest 3\"\n        title=\"jest 3\"\n        src=\"/static/67b08f1411831524885dc8a4221881a6/fcda8/jest-3.png\"\n        srcset=\"/static/67b08f1411831524885dc8a4221881a6/12f09/jest-3.png 148w,\n/static/67b08f1411831524885dc8a4221881a6/e4a3f/jest-3.png 295w,\n/static/67b08f1411831524885dc8a4221881a6/fcda8/jest-3.png 590w,\n/static/67b08f1411831524885dc8a4221881a6/efc66/jest-3.png 885w,\n/static/67b08f1411831524885dc8a4221881a6/c83ae/jest-3.png 1180w,\n/static/67b08f1411831524885dc8a4221881a6/b918a/jest-3.png 2780w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>プロセスの終了が行われていれば<code class=\"language-text\">node --inspect-brk ...</code>の子プロセスは１つも表示されなくなります。</p>\n<h2>refs</h2>\n<ul>\n<li><a href=\"https://jestjs.io/docs/troubleshooting\">https://jestjs.io/docs/troubleshooting</a></li>\n<li><a href=\"https://developer.chrome.com/docs/devtools/javascript/breakpoints/#exceptions\">https://developer.chrome.com/docs/devtools/javascript/breakpoints/#exceptions</a></li>\n</ul>","fileAbsolutePath":"/home/runner/work/blog.magcho.com/blog.magcho.com/src/pages/2022/9/jest-did-not-exit.md","frontmatter":{"title":"JestでJest did not exit one second after the test run has completedでテストが終了してもJestのプロセスが終了しない時のデバッグ","tags":["Jest"],"category":"プログラミング","fullDate":"2022-09-20"},"fields":{"lastFileUpdatedAt":"2022-09-20","fileRevisionCount":"1"}},"allMarkdownRemark":{"group":[{"fieldValue":"3D_printer"},{"fieldValue":"AWS"},{"fieldValue":"Apple Watch"},{"fieldValue":"Arduino"},{"fieldValue":"Art-Net"},{"fieldValue":"Chrome"},{"fieldValue":"DMX512"},{"fieldValue":"Docker"},{"fieldValue":"GitHub Actions"},{"fieldValue":"Gulp"},{"fieldValue":"Homebrew"},{"fieldValue":"Jest"},{"fieldValue":"M5Paper"},{"fieldValue":"Netlify"},{"fieldValue":"Nginx"},{"fieldValue":"OLA"},{"fieldValue":"OSS"},{"fieldValue":"SOAP"},{"fieldValue":"TypeScript"},{"fieldValue":"dotz"},{"fieldValue":"emacs"},{"fieldValue":"gatsby.js"},{"fieldValue":"git"},{"fieldValue":"github"},{"fieldValue":"go"},{"fieldValue":"golang"},{"fieldValue":"homebrew"},{"fieldValue":"lily58"},{"fieldValue":"mac"},{"fieldValue":"macOS"},{"fieldValue":"qmk firmware"},{"fieldValue":"tmux"},{"fieldValue":"use-package"},{"fieldValue":"youtube live"},{"fieldValue":"インターンシップ"},{"fieldValue":"ブログ"},{"fieldValue":"ポリッドスクリーン"},{"fieldValue":"参加レポ"},{"fieldValue":"思ったこと"},{"fieldValue":"生産性のない話"},{"fieldValue":"自作キーボード"},{"fieldValue":"読書"}]}},"pageContext":{"slug":"/2022/9/jest-did-not-exit/","previous":{"excerpt":"スタート当初はOpenAPIが存在せず、仕様を整理する目的で後からOpenAPIが追加されたプロジェクトがありました。OpenAPIの仕様を満たせているかは人力でレビューするのみでありスキーマを定義した旨味がないなーと思っていたので後からOpenAPIを追加した場合でも仕様を満たせていることを担保できる仕組みを整備しました。 SwaggerもといOpenAPIはAPIの定義ファイルから openapi-generator-cli などを利用して定義通りのリクエストであることを担保できます。しかしこの方法はプロジェクト立ち上げ時の既存コードがない状態ではいいですが、既存のコードがあるとこの自動生成コードに置き換える必要があり大変です。 既存コードではAxiosでリクエストを行いJestの単体テストを行う環境が整備されていたのでここに乗っかる形で自動テスト時にOpenAPI…","fields":{"slug":"/2022/9/openapi-validation-test/"},"frontmatter":{"date":"09/19","title":"既存プロジェクトに後からopenapiを追加してAxiosのリクエストをJestでテストしたい","category":"プログラミング","tags":["Jest"]}},"next":null}},"staticQueryHashes":["1324386404","4172131656","848935343"]}