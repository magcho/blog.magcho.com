{"componentChunkName":"component---src-templates-blog-post-jsx","path":"/2021/10/emacs-ng/","result":{"data":{"site":{"siteMetadata":{"title":"magcho's blog","author":"magcho"}},"markdownRemark":{"id":"fbc542e6-221d-54af-80b6-4dd373c2202f","excerpt":"https://github.com/emacs-ng/emacs-ng 先日emacs-ngという通常のEmacsをforkしRustのWebrenderとDenoのランタイムを加えたプロジェクトを見つけました。README…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/14f7ba426532f6ee327dfc946d26b1fd/1b19f/emacs-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.13513513513513%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACGklEQVQoz53Sa2vTYBQH8HwLEdzM/Z7myf3WLE1smyZbuzmYlzk2dUN8oSIyYfjVlfOXplsRmXvhix/nnycnh5MQrj+8+vX6/Bqvz6/p1dk3Or34TueXN/Tuww+6uLqhk9OvdHTyibrV1dZieTloD97T8vgjPX/xeXD88gtxrj9DmC7Jj3s43gzWqIHtNmBBO7DZFKoxhqikkLUCil5A1nJIag5BTiGpGVSjxA4f4NFjCxwL5hSmK7CwI5vNaOS35HjzIW/qlFSjJN2qyLAnJKk5iWq2oWTD9XCmZCQoKXGuV9K4OkBVr2jSHKJqDlGUHZJshiBqECUzFOU+1j152SPJW/jhBGHcDPf9sEaczoYzL5iAU42CWNAPG7p+CzdYwI96eGEH3W5gjqYwnGdDNpwGNmuHVxblBKJyJ91mznYr0sw96E5OupNDs7J1hmplsNgYhlMMTHcMk42hWzkEKQb/D9yTp4zWH5eXYhLkBH/iH3jw79473M4wMLl34P+43XAz8KGNHhYRL0VD5XYFjyQtgawlJKkJyVpKsn4PLdlmad2rxBtqRrJWbH8fzpR6eKylLFnBtmrY1gShv0AU9gj8BQK/Qxzuw3PnCLwOcXQANprCEkpY/BhMP0bK3sI3zuDpb8DF+6Of8dJBsnRofjqhvaOMgs4kq+bJnYvkLkRyW5HYbV2za5HMSiK7kciuBbIbnqxaILPapd8U34AugRBd3AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"emacs 1\"\n        title=\"emacs 1\"\n        src=\"/static/14f7ba426532f6ee327dfc946d26b1fd/fcda8/emacs-1.png\"\n        srcset=\"/static/14f7ba426532f6ee327dfc946d26b1fd/12f09/emacs-1.png 148w,\n/static/14f7ba426532f6ee327dfc946d26b1fd/e4a3f/emacs-1.png 295w,\n/static/14f7ba426532f6ee327dfc946d26b1fd/fcda8/emacs-1.png 590w,\n/static/14f7ba426532f6ee327dfc946d26b1fd/efc66/emacs-1.png 885w,\n/static/14f7ba426532f6ee327dfc946d26b1fd/1b19f/emacs-1.png 991w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><a href=\"https://github.com/emacs-ng/emacs-ng\">https://github.com/emacs-ng/emacs-ng</a></p>\n<p>先日emacs-ngという通常のEmacsをfork<sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup>しRustのWebrenderとDenoのランタイムを加えたプロジェクトを見つけました。READMEに記載されているように、完全な別プロジェクトというわけではなく定期的に本家のEmacsのmasterブランチの変更を取り込み、あくまでも現行のEmacsに新しいアイディアを付与するというプロジェクトらしいです。</p>\n<p>現在のemacs-ngは本家の2021年8月24日時点のmasterを取り込んでいるためネイティブコンパイルも利用できます。</p>\n<p>Ubuntu向けのバイナリであれば<a href=\"https://github.com/emacs-ng/emacs-ng/releases\">GitHub Release</a>で配布されていますが、MacOS向けのバイナリは配布されていないので自前でビルドする必要があります。ビルド方法は<a href=\"https://emacs-ng.github.io/emacs-ng/build/building/#macos\">ドキュメントページ</a>に記載されていますがPATHが足りないなどうまくビルドできなかったので<a href=\"https://github.com/emacs-ng/emacs-ng/blob/master/.github/workflows/test.yml\">Github Actions</a>を参考に以下の手順でビルドできました。</p>\n\n        <div class=\"gatsby-code-title code-title\">\n          <span>build-maxos.sh</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">rustup <span class=\"token function\">install</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">cat</span> rust-toolchain<span class=\"token variable\">)</span></span>\n\ncargo <span class=\"token function\">install</span> cargo-cache --no-default-features --features ci-autoclean cargo-cache\ncargo-cache\n\n<span class=\"token comment\"># brew install texinfo automake gnutls autoconf llvm libgccjit</span>\n\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token string\">\"/usr/local/opt/llvm/bin:<span class=\"token environment constant\">$PATH</span>\"</span>\n\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token environment constant\">$HOME</span>/bin:<span class=\"token environment constant\">$PATH</span>\"</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CPATH</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$CPATH</span>:/usr/local/Cellar/libgccjit/11.2.0/include\"</span>\n\n./autogen.sh\n\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token string\">\"/usr/lib/ccache:/usr/local/opt/ccache/libexec:<span class=\"token environment constant\">$PATH</span>\"</span>\n\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CC</span><span class=\"token operator\">=</span>clang\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CXX</span><span class=\"token operator\">=</span>clang++\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CPP</span><span class=\"token operator\">=</span><span class=\"token string\">\"clang -E\"</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CFLAGS</span><span class=\"token operator\">=</span><span class=\"token string\">\" -g1 -O2\"</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CXXFLAGS</span><span class=\"token operator\">=</span><span class=\"token string\">\" -g1 -O2\"</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">AR</span><span class=\"token operator\">=</span>llvm-ar\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">AS</span><span class=\"token operator\">=</span>llvm-as\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">RANLIB</span><span class=\"token operator\">=</span>llvm-ranlib\n\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CARGO_INCREMENTAL</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">RUSTFLAGS</span><span class=\"token operator\">=</span><span class=\"token string\">\"-Zshare-generics=y -Cdebuginfo=1 -Copt-level=0\"</span>\n\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CPLUS_INCLUD</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\"><span class=\"token variable\">$(</span>/usr/local/opt/llvm/bin/llvm-config --includedir<span class=\"token variable\">)</span></span>:<span class=\"token variable\">$CPLUS_INCLUDE_PATH</span>\"</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">LD_LIBRARY_PATH</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\"><span class=\"token variable\">$(</span>/usr/local/opt/llvm/bin/llvm-config --libdir<span class=\"token variable\">)</span></span>:<span class=\"token variable\">$LD_LIBRARY_PATH</span>\"</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CFLAGS</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$CFLAGS</span> -march=native\"</span>\n\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">LDFLAGS</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$LDFLAGS</span> -L/usr/local/Cellar/libgccjit/11.2.0/lib/gcc/11\"</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CXXFLAGS</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$CXXFLAGS</span> -march=native -L/usr/local/Cellar/libgccjit/11.2.0/lib/gcc/11\"</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">RUSTFLAGS</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$RUSTFLAGS</span> -Ctarget-cpu=native\"</span>\n\n./configure --with-json --without-x --with-native-compilation\n\n<span class=\"token function\">make</span> -j<span class=\"token variable\"><span class=\"token variable\">$(</span>nproc<span class=\"token variable\">)</span></span></code></pre></div>\n<p>makeコマンドによりrust部のコンパイル->emacs部のコンパイル(gcc)->lisp部のコンパイルが順に行われます。DenoはRust実装なので最初の段階でDeno runtimeがビルドされました。肝心のnative compはemacsの初回起動時に行われます、詳細は<code class=\"language-text\">native compile log</code>バッファに出力され、completeが表示されるまで20分ぐらい待ちました。</p>\n<h2>詰まりどころ</h2>\n<p>自分はemacsをターミナルでしか使わないのでGUI関連を全て無くした<code class=\"language-text\">--without-x --without-ns</code>をしたかったのですが、<code class=\"language-text\">--without-ns</code>オプションを付与するとrust実装部分のコンパイルが通りませんでした。issueなどをみる感じ他の方はビルドできるっぽいのですが自分の環境では断念。NextStepがある分バイナリサイズが大きくなりますが、特にそれ以外に不都合はないのでこのままにしました。</p>\n<p><code class=\"language-text\">--with-native-compilation</code>オブションを付与するとemacs部のコンパイル時に<code class=\"language-text\">clang: error: linker command failed with exit code 1 (use -v to see invocation)</code>で止まってしまいます。<code class=\"language-text\">fatal error: 'libgccjit.h' file not found</code>となっており、コンパイラへPATHが通っていないようです。</p>\n<p>この類のPATHは<code class=\"language-text\">./configure</code>時にcheckされるはずで、実際に<code class=\"language-text\">./configure</code>のログ内でもlibgccjitにOKが付いています、なので原因わからず。とりあえずコンパイラにPATHを渡せればいいので<a href=\"https://github.com/jimeh/build-emacs-for-macos/issues/20\">https://github.com/jimeh/build-emacs-for-macos/issues/20</a> を参考にCFLAGS, LDFLAGS, LIBRARY_PATHにlibgccjitのPATHを付与してから<code class=\"language-text\">./configure</code>をやり直してめでたくビルド成功です。</p>\n<h2>さいご</h2>\n<p>Deno runtime機能を軽く触ってみた感想として、標準でTypeScriptを利用できること、WebWorkerをサクッと立てられることがとても快適です。</p>\n<p>emacs lispからは<code class=\"language-text\">(eval-js 'xxx.js')</code>のような形でDenoランタイムを呼び出します。Deno上ではグローバルスコープに<code class=\"language-text\">lisp</code>組み込みオブジェクトが追加されており、このオブジェクトに生えている関数を使ってDeno->emacsへの操作を行うようです。何も考えなくても非同期なのでDeno側で天気予報を取得するようなAPIを叩いたとして、APIのレスポンス待ちの間にemacsが固まるといったことはありません。すごい</p>\n<p>従来のelispでパッケージを書いていたときは非同期な処理を書くのが難しいと感じていたのでサクッとasync/awaitで書けるJSでemacsのパッケージが作れるようになるのは嬉しいです。vimにも似たアプローチのDenops.vimがありますがそちらは通常のvimのプラグインとしてDeno runtimeを入れられるのでemacs-ngに比べると手軽ですね。</p>\n<p>Denops.vimのパッケージをemacs-ngに移植したりといったことから始めてみようと思います。</p>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\">本家EmacsのforkのREmacsのforkのemacs-ng？<a href=\"#fnref-1\" class=\"footnote-backref\">↩</a></li>\n</ol>\n</div>","fileAbsolutePath":"/home/runner/work/blog.magcho.com/blog.magcho.com/src/pages/2021/10/emacs-ng.md","frontmatter":{"title":"emacs-ngをnative comp有効化してmacos向けにビルドした","tags":["emacs"],"category":"プログラミング","fullDate":"2021-10-11"},"fields":{"lastFileUpdatedAt":"2022-09-21","fileRevisionCount":"1"}},"allMarkdownRemark":{"group":[{"fieldValue":"3D_printer"},{"fieldValue":"AWS"},{"fieldValue":"Apple Watch"},{"fieldValue":"Arduino"},{"fieldValue":"Art-Net"},{"fieldValue":"Chrome"},{"fieldValue":"DMX512"},{"fieldValue":"Docker"},{"fieldValue":"GitHub Actions"},{"fieldValue":"Gulp"},{"fieldValue":"Homebrew"},{"fieldValue":"Jest"},{"fieldValue":"M5Paper"},{"fieldValue":"Netlify"},{"fieldValue":"Nginx"},{"fieldValue":"OLA"},{"fieldValue":"OSS"},{"fieldValue":"SOAP"},{"fieldValue":"TypeScript"},{"fieldValue":"dotz"},{"fieldValue":"emacs"},{"fieldValue":"gatsby.js"},{"fieldValue":"git"},{"fieldValue":"github"},{"fieldValue":"go"},{"fieldValue":"golang"},{"fieldValue":"homebrew"},{"fieldValue":"lily58"},{"fieldValue":"mac"},{"fieldValue":"macOS"},{"fieldValue":"qmk firmware"},{"fieldValue":"tmux"},{"fieldValue":"use-package"},{"fieldValue":"youtube live"},{"fieldValue":"インターンシップ"},{"fieldValue":"ブログ"},{"fieldValue":"ポリッドスクリーン"},{"fieldValue":"参加レポ"},{"fieldValue":"思ったこと"},{"fieldValue":"生産性のない話"},{"fieldValue":"自作キーボード"},{"fieldValue":"読書"}]}},"pageContext":{"slug":"/2021/10/emacs-ng/","previous":{"excerpt":"昨日したらvirtualboxがアップデートできなかったので対応をメモ。 エラー文 VBoxUSBでエラーなので、類似事例を探すと以下のフォーラムが見つかった。\nhttps://forum.macbidouille.com/index.php?showtopic=420332 接続してるBluetoothデバイスを外すといいと書いてある。ほんとかよと思いながらも接続していたトラックパッドとマウスのBluetoothを設定からペアリング解除し接続しているUSBデバイスを全て外したのち、再起動し\nするとすんなりアップデートできた。 Bluetoothのペアリングをやり直して今回は対応終了。 最後に ザーッと検索したところ類似のエラーが起こっている人が少なかっので、自分が追加でインストールしているExtention Packに要因があるのかもしれないと思った。検証はしてないので予想。","fields":{"slug":"/2021/7/update-virtualbox/"},"frontmatter":{"date":"07/26","title":"virtualBoxをアップデートした","category":"プログラミング","tags":["homebrew"]}},"next":{"excerpt":"初めに GitHub Actionsには2000分/月の無料枠がありますがビジュアルテストなど時間がかかりそうなテストをたくさん回そうとすると足りなくなることがあります。GitHubが提供しているSelf hosted runnerのエージェントを自前で用意したマシンに入れることで代わりの実行環境として利用できます。 VM Oracle cloudのARMマシンが余っていたのでこのマシンたちを利用して構築しました。セルフホストランナーをサポートするアーキテクチャとオペレーティングシステムに記載されているようにLinuxであればARMでも利用できます。 インストール Jenkinsのようにマシンにエージェントをインストールしてから設定するのかと思いきや、まず最初に設定するリポジトリ/Organizationの設定画面からnew self-hosted runner…","fields":{"slug":"/2021/10/github_actions_selfhosted/"},"frontmatter":{"date":"10/18","title":"GitHub Actionsのセルフホストランナーを試す","category":"プログラミング","tags":["github"]}}}},"staticQueryHashes":["1324386404","4172131656","848935343"]}