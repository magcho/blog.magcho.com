{"componentChunkName":"component---src-templates-blog-post-jsx","path":"/2020/4/goで作ったCLIツールのビルド・配布をGitHub_Actionsで自動化する/","result":{"data":{"site":{"siteMetadata":{"title":"magcho's blog","author":"magcho"}},"markdownRemark":{"id":"0fdd1587-d82d-56cb-9aa7-5e55ac85ef59","excerpt":"Goで作ったdotfiles管理ツールのdotzをビルド・バイナリ配布・homebrewのアップデートまでを自動化したメモ。 GitHub Actionsを初めて本格的に利用してみました。beta版の時はyamlにズラズラとshell script…","html":"<p>Goで作ったdotfiles管理ツールのdotzをビルド・バイナリ配布・homebrewのアップデートまでを自動化したメモ。</p>\n<p>GitHub Actionsを初めて本格的に利用してみました。beta版の時はyamlにズラズラとshell scriptのように記述した覚えがありますが現行のactionsでは考え方が違うようです。</p>\n<h2>github actions</h2>\n<p>現行のGitHub actionsについては日本語文献もたくさんあるので詳しいことはそっちを見てほしいんですが、GitHub上ではworkflowがpushやPR、タイマーなどのトリガーによって実行されます。workflow内には任意のactionを持ちこのactionが順次/並列で実行されます。</p>\n<p>actionにはdockerのようにinputと環境変数を渡すことができ、任意の数のoutputができます。outputは別のactionのinputとして渡すことができます。</p>\n<p>また、workflow内で使える環境変数にはリポジトリ名やcommit ハッシュ等の情報に加え、tagのpushをトリガーとした時などにはtag名等様々な情報を取得できます。さらにworkflowを実行しているリポジトリのみの権限を持ったonetime GitHub tokenが払い出されます。</p>\n<p>github tokenは対象リポジトリにしか影響できないのでミスって他のリポジトリを消したりできないので安心。</p>\n<h2>dotzのビルド</h2>\n<p>dotzに利用しているcli用のライブラリ<a href=\"https://github.com/urfave/cli\">urfave/cli</a>はコマンド実行時にツールのバージョンを表示する昨日はあります、今回はtag名からバージョン番号を拾ってmakefileでビルドします。</p>\n<p>makefileはCIだけではなく開発時にも利用すると思います。開発時は<code class=\"language-text\">make</code>コマンド単体のみでビルドし、CI上のビルド時のみバージョン名を渡してビルドしたいです。このようにパラメータをオプション的に使うにはmakefile内で使える変数をコマンドラインから渡してやるといいです。</p>\n<p>makefile内で変数<code class=\"language-text\">dotz_ver</code>を定義しておきます。</p>\n\n        <div class=\"gatsby-code-title code-title\">\n          <span>makefile</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"makefile\"><pre class=\"language-makefile\"><code class=\"language-makefile\">dotz_ver <span class=\"token operator\">=</span> 0.0.0\n<span class=\"token target symbol\">build</span><span class=\"token punctuation\">:</span> main.go\n\tgo build -v -ldflags <span class=\"token string\">\"-X main.dotzVersion=${dotz_ver}\"</span> .</code></pre></div>\n<p><code class=\"language-text\">make build</code>をしたときには<code class=\"language-text\">dotz_ver</code>の中身は<code class=\"language-text\">0.0.0</code>になりますが<code class=\"language-text\">make build dotz_ver=1.2.3</code>と呼び出せばコマンドライン側の値が優先され<code class=\"language-text\">dotz_ver</code>の中身が<code class=\"language-text\">1.2.3</code>になります。これを利用してworkflowからはtag名を渡しておきます。</p>\n\n        <div class=\"gatsby-code-title code-title\">\n          <span>.github/workflows/build.yml</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">~~~~抜粋\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> build\n    <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">GO111MODULE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"on\"</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> macos<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Set up Go 1.13\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>go@v1\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">go-version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1.13</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Check out code into the Go module directory\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v2\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> make build dotz_ver=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.ref <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n~~~~抜粋</code></pre></div>\n<p>上記のmakefileにありますが、go build 時に<code class=\"language-text\">-ldflags \"main.{変数名}={value}\"</code>で値を埋め込んでいます。これでビルド時に変数を取り込み実行時は変数が格納済みの状態で実行が開始されます。</p>\n<p>ビルド後は、<a href=\"https://github.com/actions/create-release\">actions/create-release@v1</a>と<a href=\"https://github.com/actions/upload-release-asset\">actions/upload-release-asset</a>でreleaseに生成したバイナリをアップロードします。</p>\n<h2>homebrewの自動化</h2>\n<p>homebrewのformulaを自動更新するactionを作りました。</p>\n<p><a href=\"https://github.com/magcho/dotz/tree/master/.github/actions/update_homebrew\">https://github.com/magcho/dotz/tree/master/.github/actions/update_homebrew</a></p>\n<p>brewの公式リポジトリではなくオレオレformulaを対象としています。更新するactionとuploadするactionを分けたので後者を公式リポジトリにPRを送るactionに差し替えれば運用できるかなと思います。</p>\n<p>内部でやっていることは既存のformulaをcurlで落とし、<a href=\"https://github.com/magcho/dotz/blob/718af61a0ac6efa050e8ff718213d5f1a564350c/.github/actions/update_homebrew/src/main.js#L35-L36\">ここで</a>バイナリのURLとsha256を更新しているだけです。</p>\n<p>formulaによっては書き換えルールを追加しなければいけないかもですね。</p>\n<p>formulaのtestとformatを掛けたのち、formulaをuploadします。formulaのリポジトリにpushしたいところですがworkflowに払い出される通常のGitHub tokenでは実行リポジトリ以外にpushできないので別途用意します。</p>\n<p><a href=\"https://github.com/settings/tokens\">githubの個人設定</a>からPersonal access tokenを払い出してリポジトリのSettingタブ->Secretsから任意の名前でsecretに登録しておきます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9a4506b68743fbaf53a5606f177a7fdf/1a867/0601.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.37837837837838%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABkElEQVQoz5WTzXKjMBCEef9X2QfIec+57nVjx2DsdWwE+kH/+lIStrOnbC1VTc9oxNDTgu44eUbh0C4RU0UmxNTwiB+cUsZZyziOTGLBrJbz5Yo2K5fr1PJuloZFrUhlWK1jXhRmdW1TXVN6RWqDNpZFKqY/R26nHus8PsQnOx8ad/WWUySE0BQasyLEjPOelO6qm7qNq9qUC6WwAZ5xzoVumALGZ0pdAax1XC4feO9bnvNWq9ziO+r4MUZSjBun1PZ1FxkJ6auhlIrdbs8wDA37/TuHfuDQ9/x+2zEMR94PPafzuU0yzZJ5kVhr2/PdUQTSXUWFdY7bIhFKI6RC1FjMLItkmkTjmksp2yEsNuPTJqYpHEXA+txMqB7kkuHXK/x8gZcf0O/4/irNAiMWgg9VYSTE3Aq1YUwROY3o24i+HlFqwudIyQ8f/+Ztquqf/rjiraM7CctNb01LyW18FTM6FRyQKM+D+Q5VXYqJ7ioUsY16f1suaJdRNm3K/9HogaeH9Q/J+es7exSf/pT/wyc4E1oHf7lVCAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"0601\"\n        title=\"0601\"\n        src=\"/static/9a4506b68743fbaf53a5606f177a7fdf/fcda8/0601.png\"\n        srcset=\"/static/9a4506b68743fbaf53a5606f177a7fdf/12f09/0601.png 148w,\n/static/9a4506b68743fbaf53a5606f177a7fdf/e4a3f/0601.png 295w,\n/static/9a4506b68743fbaf53a5606f177a7fdf/fcda8/0601.png 590w,\n/static/9a4506b68743fbaf53a5606f177a7fdf/efc66/0601.png 885w,\n/static/9a4506b68743fbaf53a5606f177a7fdf/c83ae/0601.png 1180w,\n/static/9a4506b68743fbaf53a5606f177a7fdf/1a867/0601.png 1998w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>あとはworkflowから<code class=\"language-text\">${{secrets.****}}</code>で参照できるのでtokenを渡しておきます。</p>\n\n        <div class=\"gatsby-code-title code-title\">\n          <span>.github/workflows/build.yml</span>\n        </div>\n       \n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">~~~~抜粋\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> create commit\n  <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n    sh ./ci/create_commit.sh \"dotz.rb\" \"magcho\" \"${{ secrets.github_personal_acces_token }}\" \"mail@magcho.com\"</span>\n~~~~抜粋</code></pre></div>\n<p>これにてtag付きでmasterにpushすれば勝手にリリースまでやってくれるようになります。</p>\n<h2>おわり</h2>\n<p>そういやGitHub actionsハッカソンがありました。気づいた時は最終日でしたが、、</p>\n<p>github actions marketplaceに全然actionの種類がないなーと思ってたとこなのでハッカソンで一気に増えた感じですかね。自分もなんか出したかったな。</p>","fileAbsolutePath":"/home/runner/work/blog.magcho.com/blog.magcho.com/src/pages/2020/4/goで作ったCLIツールのビルド・配布をGitHub_Actionsで自動化する.md","frontmatter":{"title":"Goで作ったCLIツールのビルド・配布をGitHub Actionsで自動化する","tags":["go","GitHub Actions","dotz"],"category":"プログラミング","fullDate":"2020-04-06"},"fields":{"lastFileUpdatedAt":"2022-09-17","fileRevisionCount":"1"}},"allMarkdownRemark":{"group":[{"fieldValue":"3D_printer"},{"fieldValue":"AWS"},{"fieldValue":"Apple Watch"},{"fieldValue":"Arduino"},{"fieldValue":"Art-Net"},{"fieldValue":"Chrome"},{"fieldValue":"DMX512"},{"fieldValue":"Docker"},{"fieldValue":"GitHub Actions"},{"fieldValue":"Gulp"},{"fieldValue":"Homebrew"},{"fieldValue":"M5Paper"},{"fieldValue":"Netlify"},{"fieldValue":"Nginx"},{"fieldValue":"OLA"},{"fieldValue":"OSS"},{"fieldValue":"SOAP"},{"fieldValue":"TypeScript"},{"fieldValue":"dotz"},{"fieldValue":"emacs"},{"fieldValue":"gatsby.js"},{"fieldValue":"git"},{"fieldValue":"github"},{"fieldValue":"go"},{"fieldValue":"golang"},{"fieldValue":"homebrew"},{"fieldValue":"lily58"},{"fieldValue":"mac"},{"fieldValue":"macOS"},{"fieldValue":"qmk firmware"},{"fieldValue":"tmux"},{"fieldValue":"use-package"},{"fieldValue":"youtube live"},{"fieldValue":"インターンシップ"},{"fieldValue":"ブログ"},{"fieldValue":"ポリッドスクリーン"},{"fieldValue":"参加レポ"},{"fieldValue":"思ったこと"},{"fieldValue":"生産性のない話"},{"fieldValue":"自作キーボード"},{"fieldValue":"読書"}]}},"pageContext":{"slug":"/2020/4/goで作ったCLIツールのビルド・配布をGitHub_Actionsで自動化する/","previous":{"excerpt":"感染防止などの理由でいつもは集まって行なっていたミーティングができなくなってしまったので、今回youtube liveでリアルタイム配信をやってみたレポートです。 使用した機材やつまづきポイントなどを書いておくので何かの助けになれば幸いです。 事の発端 大学のサークルにて月に一回所属している人を大教室に集めて情報共有などを行う習慣があり、2月までは大教室に付属するプロジェクターとマイクを用いて講義のような形式で行なっていた。しかし3月は感染防止の観点から大学側より集会禁止の通知が届いたため中止に。 この時期は大学のサークルということもあり新歓などで慌ただしく情報共有の場が必要でした。その他のことも忙しい時期らしい。なので予定していた日付はそのままで配信集会をやろうということになった。 配信準備   今回使用した機材は以下 ビデオミキサー V-1HD Roland PC…","fields":{"slug":"/2020/4/ネット配信をやってみたレポ/"},"frontmatter":{"date":"04/01","title":"youtube liveでネット配信をやったレポ","category":"日記","tags":["youtube live"]}},"next":{"excerpt":"キー入力が下手なのでバックスペースを連打しがちなのですがバックスペースキーはキーボード上では遥か右上にあります。これが原因で右手首を痛めたことも。入力精度を上げろという話なのですが出来るならもうしてます。 また、以外と日本語入力をしていると使いがちな「ー」伸ばし棒も近くに欲しいものです。 今回はにbackspace・にハイフンを割り当てます。 Ctrlキー Ctrlキー含め装飾キーには様々なキーバインドが割り当てられています。一般的にはにはreturn・にはbackspaceなど色々あります。zsh/bashなどのshellやターミナルのキーバインドに設定されていることが多いです。macではに行末まで削除があったりと気が利いています。 qmk firmwareではraise/lower…","fields":{"slug":"/2020/4/qmk_firmwareでctrlとの同時押しをカスタマイズする/"},"frontmatter":{"date":"04/08","title":"qmk firmwareでctrlとの同時押しをカスタマイズする","category":"プログラミング","tags":["qmk firmware","自作キーボード"]}}}},"staticQueryHashes":["1324386404","4172131656","848935343"]}